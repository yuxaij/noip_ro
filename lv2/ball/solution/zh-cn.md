{{ self.title() }}

Author: yuxaij@gmail.com

## 搜索

按题面描述搜索即可。

当 $n,m$ 较小时可以记忆化搜索。将当前小球占据的凹槽集合作为一维的 DP 状态即可，滚出斜面的小球个数与占据的凹槽个数之和即为当前落下的小球总数。

## 有序化

由于搜索时每次只能获得一个合法序列，可以考虑如何快速地统计方案——将这些合法序列按某些规律划分成若干组，并保证对于每一组，可以较快地统计组内序列的个数。

沿状压的思路，容易看出可以将方案根据其操作结束后，小球最终占据的凹槽集合来分类。不妨考察在何时，两个方案的结果相同。

对于一个方案而言，当一个小球滚到某个凹槽并发现该凹槽上存在另一个小球时，交换这两个小球的身份，即让原先在凹槽中的小球替代当前的小球继续沿斜面滚动、而当前的小球占据这个凹槽，并不会影响方案的最终结果。因此，可以考虑将一个方案有序化，即给小球编号 $1 \sim m$，并要求编号更大的小球所占据凹槽的位置应该更高：即，若一个编号更大的小球发现当前凹槽中有一个编号更小的小球时，让更小的小球替代它向前滚动。

## 另一个角度

从另一个方面来说，也可以考虑将方案的序列有序化。考虑若一个方案中存在 $p_i > p_{i-1}$，则：

+ 这两个操作不相关，即 $p_i$ 落下的小球并未滚到 $p_{i-1}$ 及之前的位置；此时可以交换这两个操作。
+ 这两个操作相关，即 $p_i$ 落下的小球滚到了 $p_{i-1}$ 之前的某个位置 $t$，即 $[t, p_i]$ 这个区间内的所有凹槽均在此之前已被占据。容易看出，交换 $p_{i}, p_{i-1}$ 并不影响方案。

故统计所有本质不同的有序方案，再对每个有序方案求出其的变种个数即可。对于一个合法的有序方案 $p(p_1, p_2, \dots, p_m)$，令其本质不同的数的出现次数分别为 $cnt_1, cnt_2, \dots, cnt_r$，则该有序方案的变种个数可通过多重排列公式得到 

$$P(m, cnt_1, cnt_2, \dots, cnt_r) = \frac{m!}{cnt_1!cnt_2!\cdots cnt_r!}.$$

令 $f(i,j,k)$ 表示考虑了有序方案中落下的前 $i$ 小球，其中最后一个小球落下的位置为 $j$，有 $k$ 个小球滚出了斜面的有序方案总个数。根据多重排列计算的公式，可知每次转移时应枚举一个新的位置 $j'$，并枚举该位置上落下的小球个数 $\Delta i$，再更新到 $f(i+\Delta i, j', k')$。

这个枚举新的位置可以直接考虑 $j'=j+1$，只要令 $\Delta i$ 可以为 $0$ 即可（更严谨的说法是利用前缀和加速）。考虑在位置 $j+1$ 上落下了 $\Delta i$ 个小球，我们想知道这些球中有多少个滚出了斜面。由于之前一共落下了 $i$ 个小球，这 $i$ 个小球中有 $k$ 个滚出了斜面，因此在 $[1,j+1]$ 这个范围内有 $i-k$ 个凹槽被占据，有 $j+1-(i-k)$ 个凹槽是空的。显然，新滚出斜面的小球恰好有 $\Delta k = \max \left(\Delta_i - [j+1-(i-k)], 0\right)$ 个。

这 $\Delta i$ 个小球在多重排列中贡献的除子为 $\Delta i!$。可得到递推式的转移：

$$ f(i,j,k) \times (\Delta i!)^{-1} \to f(i+\Delta i, j+1,k+\Delta k)$$

最终答案即为 $m! \times f(m, n, k)$。

## 特殊情况

考虑 $n=m,k=0$ 的特殊情况。此时所有合法方案得到的最终结果都是一样的：没有小球滚出斜面且所有凹槽均被占据。

考察最后一个小球最终占据的凹槽 $r$。可以发现，之前的 $m-1$ 个小球占据的凹槽集被划分成两个连续段：$[1,r-1]$ 和 $[r+1,n]$，而这两个连续段是不相关的——由于没有小球经过 $r$，因此落在前面连续段的小球必然是从位置 $[1,r-1]$ 开始下落的，故前面的连续段是一个规模为 $r-1$ 的子问题。而对于后面连续段而言，所有小球必然从 $[r+1,n]$ 中的某个位置开始下落，且没有小球滚出这个区间，因此后面连续段是一个规模为 $n-r$ 的子问题。这两个连续段的操作互不影响。

令前面连续段的方案数为 $f(r-1)$，后面连续段的方案数为 $f(n-r)$，则对于所有满足最后一个落下小球占据凹槽编号为 $r$ 的全局方案，其前 $m-1$ 次操作的变种数量为：

$$ f(r-1) \times f(n-r) 

考虑对于任意的两个连续段方案 $p_first, p_second$ 如何产生全局
最后一个即第 $m$ 个落下小球

## 更进一步

